# ============================================================
# SIT ç¯å¢ƒ ArgoCD å®Œæ•´éƒ¨ç½²é…ç½® (ä¸€é”®éƒ¨ç½²ç‰ˆæœ¬)
# ============================================================
# 
# ğŸ“ å­¦ä¹ è¯´æ˜:
# è¿™æ˜¯ SIT ç¯å¢ƒçš„å®Œæ•´ ArgoCD éƒ¨ç½²é…ç½®æ–‡ä»¶
# åŒ…å«å‘½åç©ºé—´ã€å®Œæ•´RBACæƒé™ã€App of Appsåº”ç”¨
#
# ğŸ”§ é…ç½®ç‰¹ç‚¹:
# - ä½¿ç”¨ argocd-sit å‘½åç©ºé—´å®ç°ç¯å¢ƒéš”ç¦»
# - å®Œæ•´RBACæƒé™é…ç½®ï¼Œç¡®ä¿ä¸€é”®éƒ¨ç½²æˆåŠŸ
# - æ— åˆå§‹å¯†ç é…ç½®ï¼Œä½¿ç”¨ArgoCDéšæœºç”Ÿæˆå¯†ç 
# - çœŸæ­£çš„ä¸€é”®éƒ¨ç½²ï¼Œæ— éœ€é¢å¤–é…ç½®
#
# ğŸš€ éƒ¨ç½²å‘½ä»¤:
# kubectl apply -f app-of-apps.yaml
# kubectl apply -n argocd-sit -f https://raw.githubusercontent.com/argoproj/argo-cd/stable/manifests/install.yaml
# kubectl patch svc argocd-server -n argocd-sit -p '{"spec":{"type":"NodePort","ports":[{"port":80,"nodePort":30089}]}}'
# ============================================================

# å‘½åç©ºé—´
apiVersion: v1
kind: Namespace
metadata:
  name: argocd-sit
  labels:
    environment: sit
    app.kubernetes.io/name: argocd
---
# å®Œæ•´é›†ç¾¤æƒé™ - ç¡®ä¿ä¸€é”®éƒ¨ç½²æˆåŠŸ
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: argocd-application-controller-sit
rules:
# å®Œæ•´æƒé™ï¼Œç¡®ä¿ArgoCDèƒ½è®¿é—®æ‰€æœ‰èµ„æº
- apiGroups: ["*"]
  resources: ["*"]
  verbs: ["*"]
# éèµ„æºURLæƒé™
- nonResourceURLs: ["*"]
  verbs: ["*"]
---
# é›†ç¾¤æƒé™ç»‘å®š
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: argocd-application-controller-sit
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: argocd-application-controller-sit
subjects:
- kind: ServiceAccount
  name: argocd-application-controller
  namespace: argocd-sit
---
# App of Appsåº”ç”¨ - ç®¡ç†æ‰€æœ‰SITç¯å¢ƒåº”ç”¨
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: app-of-apps-sit
  namespace: argocd-sit
  labels:
    environment: sit
    app.kubernetes.io/name: app-of-apps
spec:
  project: default
  source:
    repoURL: https://github.com/1979447992/project-gitops-config.git
    targetRevision: sit
    path: argocd/applications
  destination:
    server: https://kubernetes.default.svc
    namespace: argocd-sit
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
      - CreateNamespace=true
      - ServerSideApply=true
