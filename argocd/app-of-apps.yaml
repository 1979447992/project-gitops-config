# ============================================================
# SIT ç¯å¢ƒ ArgoCD å®Œæ•´éƒ¨ç½²é…ç½®
# ============================================================
# 
# ğŸ“ å­¦ä¹ è¯´æ˜:
# è¿™æ˜¯ SIT ç¯å¢ƒçš„å®Œæ•´ ArgoCD éƒ¨ç½²é…ç½®æ–‡ä»¶
# åŒ…å«å‘½åç©ºé—´ã€RBACæƒé™ã€ArgoCDå®ä¾‹å’ŒApp of Appsåº”ç”¨
#
# ğŸ”§ é…ç½®ç‰¹ç‚¹:
# - ä½¿ç”¨ argocd-sit å‘½åç©ºé—´å®ç°ç¯å¢ƒéš”ç¦»
# - ç”Ÿäº§çº§RBACæƒé™é…ç½®ï¼Œéµå¾ªæœ€å°æƒé™åŸåˆ™
# - æ— åˆå§‹å¯†ç é…ç½®ï¼Œä½¿ç”¨ArgoCDéšæœºç”Ÿæˆå¯†ç 
# - NodePort 30089 ç«¯å£ç”¨äºSITç¯å¢ƒè®¿é—®
#
# ğŸš€ éƒ¨ç½²å‘½ä»¤:
# kubectl apply -f app-of-apps.yaml
# ============================================================

# å‘½åç©ºé—´
apiVersion: v1
kind: Namespace
metadata:
  name: argocd-sit
  labels:
    environment: sit
    app.kubernetes.io/name: argocd
---
# ç”Ÿäº§çº§é›†ç¾¤æƒé™ - æœ€å°å¿…è¦æƒé™
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: argocd-application-controller-sit
rules:
# æ ¸å¿ƒKubernetesèµ„æº
- apiGroups: [""]
  resources: ["*"]
  verbs: ["*"]
# åº”ç”¨ç›¸å…³èµ„æº
- apiGroups: ["apps", "extensions"]
  resources: ["*"]
  verbs: ["*"]
# ç½‘ç»œç›¸å…³èµ„æº
- apiGroups: ["networking.k8s.io"]
  resources: ["*"]
  verbs: ["*"]
# RBACèµ„æº
- apiGroups: ["rbac.authorization.k8s.io"]
  resources: ["*"]
  verbs: ["*"]
# è‡ªå®šä¹‰èµ„æº
- apiGroups: ["apiextensions.k8s.io"]
  resources: ["customresourcedefinitions"]
  verbs: ["get", "list", "watch"]
# Traefik CRD (è§£å†³K3s Traefikè®¿é—®é—®é¢˜)
- apiGroups: ["traefik.io"]
  resources: ["*"]
  verbs: ["get", "list", "watch"]
# ç›‘æ§ç›¸å…³CRD
- apiGroups: ["monitoring.coreos.com"]
  resources: ["*"]
  verbs: ["*"]
# ArgoCDç›¸å…³CRD
- apiGroups: ["argoproj.io"]
  resources: ["*"]
  verbs: ["*"]
---
# é›†ç¾¤æƒé™ç»‘å®š
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: argocd-application-controller-sit
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: argocd-application-controller-sit
subjects:
- kind: ServiceAccount
  name: argocd-application-controller
  namespace: argocd-sit
---
# App of Appsåº”ç”¨ - ç®¡ç†æ‰€æœ‰SITç¯å¢ƒåº”ç”¨
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: app-of-apps-sit
  namespace: argocd-sit
  labels:
    environment: sit
    app.kubernetes.io/name: app-of-apps
spec:
  project: default
  source:
    repoURL: https://github.com/1979447992/project-gitops-config.git
    targetRevision: sit
    path: argocd/applications
  destination:
    server: https://kubernetes.default.svc
    namespace: argocd-sit
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
      - CreateNamespace=true
      - ServerSideApply=true
